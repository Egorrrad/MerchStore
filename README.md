# MerchStore

---

Реализация тестового задания на позицию стажёра-бэкендера в Avito с использованием JWT-аутентификации, PostgreSQL и Redis.

## Тестовое задание

Тестовое задание доступно по ссылке: [Avito Backend Trainee Assignment 2025](https://github.com/avito-tech/tech-internship/blob/main/Tech%20Internships/Backend/Backend-trainee-assignment-winter-2025/Backend-trainee-assignment-winter-2025.md)

## Выполненные задачи
1. **Реализация сервиса**:
   - Аутентификация пользователей через JWT.
   - Покупка мерча с использованием виртуальной валюты.
   - Обмен монетами между пользователями
   - История операций с монетами.
   - Кэширование токенов пользователей в Redis.

2. **Тестирование**:
   - Полное покрытие E2E-тестами всех путей API.
   - Частичное покрытие юнит-тестами.

3. **Контейнеризация**:
   - Сервис полностью запускается через Docker.
   - Использование `Makefile` для упрощения запуска и управления контейнерами.

4. **Линтинг**:
   - Настроен линтер.
5. **Нагрузочное тестирование**:
   - Проведено нагрузочное тестирование полученного решения

## Невыполненные задачи
1. **Юнит-тесты**:
   - Не все компоненты покрыты юнит-тестами.
---

## Технологии

- **Язык программирования**: Go 1.23+
- **База данных**: PostgreSQL
- **Кэширование**: Redis
- **Аутентификация**: JWT
- **Контейнеризация**: Docker и docker-compose
- **Тестирование**:
   - Unit-тесты
   - E2E-тесты
   - Нагрузочное тестирование

---

## Требования

Для запуска сервиса необходимо установить:
- **Go** (версия 1.23 или выше)
- **Docker** и **docker-compose**

---

## Описание запуска

### 1. Клонирование репозитория
```bash
git clone https://github.com/Egorrrad/MerchStore.git
cd MerchStore
```

### 2. Запуск сервиса через Docker
Для удобства запуска сервиса используется `Makefile`. Доступные команды:
- **Запуск сервиса**:
  ```bash
  make run-service
  ```
  Эта команда соберет и запустит все контейнеры (PostgreSQL, Redis и API).

- **Остановка сервиса**:
  ```bash
  make stop-service
  ```

- **Удаление контейнеров**:
  ```bash
  make rm-service
  ```

---

## Результаты тестирования

### 1. **E2E-тесты**
E2E-тесты покрывают все пути API и запускаются в изолированном тестовом окружении, которое настраивается через Go-файл при запуске тестов.

### 2. **Юнит-тесты**
Частично реализованы юнит-тесты для ключевых компонентов (репозиторий, сервисы, обработчики).

### 3. **Запуск тестов**
Для запуска тестов выполните:
```bash
make run-tests
```
Также в консоли будет отображена краткая информация о покрытии тестами. Для получения детальной информации о покрытии можно перейти к следующемцу пункту.
### 4. **Покрытие тестами**
Для просмотра покрытия тестами выполните:
```bash
make test-cov
```

## Нагрузочное тестировние
Нагрузочное тестирование проводилось с помощью сервиса k6. Его результаты представлены в файле [summary.txt](https://github.com/Egorrrad/MerchStore/blob/main/summary.txt).
Тестирование можно провести самостоятельно. Для этого нужно установить k6.
На MacOS это можно сделать командой:
```bash
brew install k6
```
Выполнить команду для запуска тестирования:
```bash
make test-load
```
---

## Дополнительно

### 1. **Использование Redis**
Для повышения производительности сервиса токены пользователей кэшируются в Redis. Это позволяет:
- Уменьшить количество запросов к PostgreSQL.
- Ускорить процесс аутентификации.
- Снизить нагрузку на базу данных.

Каждый раз, когда пользователь аутентифицируется, его токен сохраняется в Redis. При последующих запросах токен проверяется сначала в Redis, и только если он отсутствует, выполняется запрос к PostgreSQL.

### 2. **Makefile**
Для упрощения работы с сервисом используется `Makefile`:
- **Запуск сервиса**: `make run-service`
- **Остановка сервиса**: `make stop-service`
- **Удаление контейнеров**: `make rm-service`
- **Запуск тестов**: `make run-tests`
- **Подробный просмотр покрытия тестами**: `make test-cov`
- **Запуск нагрузочных тестов**: `make test-load`


### 3. **E2E-тесты**
E2E-тесты запускаются в изолированном окружении, которое настраивается через Go-файл. Это позволяет:
- Запускать тесты независимо от основного окружения.
- Использовать тестовую базу данных и Redis.
- Очищать данные после каждого теста.

### 4. **Логирование**
Добавлено логирование запуска сервиса и также логирование обработки запросов.

## Вопросы по ТЗ и их решение
### Вопрос
Нужно ли запретить пользователю отправлять монеты себе?
### Ответ
Отправка монет самому себе не имеет смысла и может привести к неожиданным ошибкам, например, искусственное увеличение баланса.
Поэтому нужно запретить отправлять монеты самому себе.
### Вопрос
Нужно ли хранить JWT токены в бд?
### Ответ
Нет, если не требуется отслеживать активные токены или реализовать их отзыв.
Для базового сценария JWT не хранится в БД — валидация происходит через проверку подписи и данных в токене.
Для отзыва токенов можно использовать blacklist в Redis или БД, куда добавляются отозванные токены до их истечения.
## Проблемы и их решение
### Проблема
Как изолировать процесс покупки мерча или передачи монеток?
### Решение
Необходимо обеспечить атомарность операций (покупка мерча или перевод монет), чтобы избежать race conditions.
Для этого можно использовать транзакции в БД, чтобы изолировать операции.
### Проблема
Как повысить производительность проверки наличия токена в бд?
### Решение
Частые запросы к БД для проверки токенов могут снизить производительность.
Поэтому нужно использовать кэширование (Redis) и TTL. Установить срок жизни токена в кэше, чтобы устаревшие токены автоматически удалялись.
### Проблема
Как изолировать выполнение E2E тестов?
### Решение
E2E тесты могут влиять друг на друга, если они используют общие ресурсы.
Поэтому нужно настроить тестовое окружение и использовать его при запуске E2E тестов.

